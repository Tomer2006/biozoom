<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Taxonomy Explorer</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://en.wikipedia.org" crossorigin>
  <link rel="modulepreload" href="app-modular.js">
  <link rel="modulepreload" href="modules/canvas.js">
  <link rel="modulepreload" href="modules/render.js">
  <link rel="modulepreload" href="modules/events.js">
  <link rel="modulepreload" href="modules/data.js">
  <link rel="modulepreload" href="modules/layout.js">
  <link rel="modulepreload" href="modules/performance.js">
  <link rel="modulepreload" href="modules/state.js">
  <script type="importmap">
  {
    "imports": {
      "d3-hierarchy": "https://cdn.jsdelivr.net/npm/d3-hierarchy@3/+esm",
      "d3-ease": "https://cdn.jsdelivr.net/npm/d3-ease@3/+esm"
    }
  }
  </script>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="title">Taxonomy Explorer</div>
    <div class="controls">
      <button class="btn" id="loadBtn" title="Load custom JSON">Load JSON</button>

      <select id="providerSelect" class="select" title="Choose provider">
        <option value="google">Google</option>
        <option value="wikipedia">Wikipedia</option>
        <option value="gbif">GBIF</option>
        <option value="ncbi">NCBI Taxonomy</option>
        <option value="col">Catalogue of Life</option>
        <option value="inat">iNaturalist</option>
      </select>
      <button class="btn" id="providerSearchBtn" title="Open provider (hovered/current)">Web Search</button>

      

      <button class="btn secondary" id="exportPngBtn" title="Export snapshot as PNG">Export PNG</button>

      <div class="searchbar" title="Local search (Enter)">
        <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="#9aa3c7" d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23A6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 5 1.5-1.5-5-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        <input id="searchInput" type="search" aria-label="Search organisms" placeholder="Search organism or groupâ€¦ (Enter)" />
        <button class="btn" id="searchBtn" title="Search">Search</button>
        <button class="btn secondary" id="clearBtn" title="Clear search">Clear</button>
        <div class="search-results" id="searchResults" role="listbox" aria-label="Search results" aria-live="polite"></div>
      </div>
      <button class="btn" id="surpriseBtn" title="Jump to a random deepest life form">Surprise Me</button>
      <button class="btn" id="fitBtn" title="Fit hovered/current into view">Fit</button>
      <button class="btn secondary" id="copyLinkBtn" title="Copy deep link to this view">Copy Link</button>
      <button class="btn secondary" id="resetBtn" title="Back to root">Reset</button>
    </div>
  </div>

  <div class="breadcrumbs" id="breadcrumbs"></div>

  <div class="stage" id="stage" aria-busy="false">
    <canvas id="view"></canvas>
    <div class="fps" id="fps" aria-live="polite">â€” fps</div>
    <div class="big-preview" id="bigPreview" aria-hidden="true">
      <img id="bigPreviewImg" alt="" decoding="async" />
      <div class="cap" id="bigPreviewCap"></div>
    </div>
    <div class="tooltip" id="tooltip">
      <div class="textcol">
        <div class="name"></div>
        <div class="meta"></div>
      </div>
      <div class="actions">
        <button class="ext" id="tooltipSearchBtn" title="Search this name in selected provider">ðŸ”Ž</button>
      </div>
    </div>

    <div class="legend">
      <div><b>Controls</b></div>
      <ul>
        <li><b>Left Click</b>: Zoom into a group</li>
        <li><b>Right Click</b>: Zoom out to parent</li>
        <li><b>Mouse Wheel</b>: Smooth zoom</li>
        <li><b>Middle Drag</b>: Pan the view</li>
        <li><b>Keyboard S</b>: Web Search hovered/current node</li>
      </ul>
      <div style="margin-top:.4rem"><b>Circle size</b> â‰ˆ number of descendant species</div>
    </div>

    <div class="loading" id="loading">
      <div class="loader">
        <div class="splash-brand" aria-hidden="true">
          <div class="logo">ðŸ§¬</div>
          <div class="brand-title">Taxonomy Explorer</div>
          <div class="brand-sub">Zoom through the tree of life while we get things readyâ€¦</div>
        </div>
        <h3><span id="loadingTitle">Loadingâ€¦</span></h3>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-meta"><span id="progressLabel" role="status" aria-live="polite" aria-atomic="true">Startingâ€¦</span><span id="progressPct">0%</span></div>
        <div class="splash-hint" aria-hidden="true">Tip: Press <b>?</b> for help, <b>F</b> to fit, <b>S</b> for web search</div>
      </div>
    </div>

    <div class="pulse" id="pulse"></div>
    <div class="puff-link" id="puffLink"><a id="puffLinkAnchor" href="#" download="biozoom.png">Download PNG</a></div>
  </div>
</div>

<!-- JSON Modal -->
<div class="modal" id="jsonModal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title">Load Custom Taxonomy JSON</div>
      <div style="display:flex;gap:.5rem">
        <button class="btn secondary" id="insertSampleBtn">Insert sample</button>
        <button class="btn secondary" id="cancelLoadBtn">Cancel</button>
        <button class="btn" id="applyLoadBtn">Parse & Load</button>
      </div>
    </div>
    <div class="modal-body">
      <div>
        <div class="filebox">
          <input type="file" id="fileInput" accept=".json,application/json" />
          <span class="error" id="loadError"></span>
        </div>
        <textarea id="jsonText" placeholder='Paste your JSON here...'></textarea>
      </div>
      <div class="side">
        <h4>Supported Schemas</h4>
        <p>1) Array/object with children: <code>{ name, level?, children:[...] }</code>. Level inferred if missing.</p>
        <p>2) Nested key map: <code>{ "Life": { "Bacteria": { ... } } }</code>. Auto-transformed.</p>
      </div>
    </div>
  </div>
  </div>

<!-- Help Modal -->
<div class="modal" id="helpModal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title">Keyboard Shortcuts & Controls</div>
      <div style="display:flex;gap:.5rem">
        <button class="btn secondary" id="helpCloseBtn" title="Close help">Close</button>
      </div>
    </div>
    <div class="modal-body" style="grid-template-columns:1fr">
      <div class="side" style="grid-column:1">
        <h4>Navigation</h4>
        <p><b>Left Click</b>: Zoom into a group</p>
        <p><b>Right Click</b>: Zoom out to parent</p>
        <p><b>Mouse Wheel</b>: Smooth zoom</p>
        <p><b>Middle Drag</b>: Pan</p>
        <p><b>Hover</b>: Show image preview</p>
        <h4 style="margin-top:.6rem">Keyboard</h4>
        <p><b>S</b>: Web search hovered/current</p>
        <p><b>R</b>: Reset to root</p>
        <p><b>F</b>: Fit current node in view</p>
        <p><b>P</b>: Pin / unpin image preview</p>
        <p><b>?</b>: Toggle this help</p>
      </div>
    </div>
  </div>
</div>

  <script type="module" src="app-modular.js"></script>
</body>
</html>

